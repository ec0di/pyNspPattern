# pyNspPattern

Solves the Nurse Scheduling Problem (NSP) with 1-week and 2-week patterns generated up front. The solution is optimized over 2 weeks and patched together with next 2 weeks using the former as starting conditions.

Furthermore, a Column Generation algorithm is implemented
to speed up the solution process if needed.

## Installation
I have used Python 3.10, but this might work with other versions as well.

I recommend using a virtual environment to install the required packages. To do so, run the following commands:

```bash pip install -r requirements.txt```

## Usage
The main file is `main.py`. To run the program, simply run the following command:

```bash python main.py```

0r go into `main.py` and play around with the parameters. You can generated a any even numbered plan either using a full 
solution or column generation algorithm where you specify how long time you want to run it for each 2 week period.

Note that the more static input parameters such as nurse demand and supply and number of shift types are stored in input_parameters.py.

## How it works
The program is based of my original work from my [Thesis](https://www.dropbox.com/s/p2memkka1tygggx/Main%20Thesis%20File.pdf?dl=0) from 2017 at DTU working together with Riget to optimize their nurse scheduling.
Although at the time I never got Column Generation (CG) to work properly, I decided to give it another shot with patterns generated up front instead, which turns out to be quite effective.

There are some slight changes to the CG model from the thesis, for instance I know only use 4 shifts types Off, Day, Evening and Night, instead of 7 from the thesis where it was Off + Day, Evening and Night for each nurse competence level (1 and 3).

This change made it possible to generate all rosters up front working with a 2 week period, and then I investigated how I could patch these together.

Further explanation and results can be found in this [Google Sheet Presentation](https://docs.google.com/presentation/d/1Sd_SwZE5Q46sYWflUblwJZJwTlvCniZiViLc7QHK9A8/edit?usp=sharing).

## Results
The speed of the program is the most impressive part. It can generate 2*n-week schedule for more than 55 nurses in less than n*5 seconds using Column Generation (a 20 pct gap from optimal solution).
Or it can find the near optimal solution in n * 3 minutes roughly.

I generated some plotly plots as well, so you can visualize the results. Here are some examples:

<html>
<head><meta charset="utf-8" /></head>
<body>
    <div>                        <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
        <script charset="utf-8" src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>                <div id="932319a1-cc52-4dfa-806e-9318d6b3f628" class="plotly-graph-div" style="height:100%; width:100%;"></div>            <script type="text/javascript">                                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("932319a1-cc52-4dfa-806e-9318d6b3f628")) {                    Plotly.newPlot(                        "932319a1-cc52-4dfa-806e-9318d6b3f628",                        [{"colorscale":[[0.0,"rgb(236, 218, 154)"],[0.16666666666666666,"rgb(239, 196, 126)"],[0.3333333333333333,"rgb(243, 173, 106)"],[0.5,"rgb(247, 148, 93)"],[0.6666666666666666,"rgb(249, 123, 87)"],[0.8333333333333334,"rgb(246, 99, 86)"],[1.0,"rgb(238, 77, 90)"]],"x":["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"y":["Day","Evening","Night"],"z":[[21,12,0,6,3,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]],"zmax":21,"zmin":0,"type":"heatmap","xaxis":"x","yaxis":"y"},{"colorscale":[[0.0,"rgb(236, 218, 154)"],[0.16666666666666666,"rgb(239, 196, 126)"],[0.3333333333333333,"rgb(243, 173, 106)"],[0.5,"rgb(247, 148, 93)"],[0.6666666666666666,"rgb(249, 123, 87)"],[0.8333333333333334,"rgb(246, 99, 86)"],[1.0,"rgb(238, 77, 90)"]],"x":["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"y":["Day","Evening","Night"],"z":[[0,9,5,0,14,7,0],[0,0,0,0,0,0,1],[0,0,0,0,0,0,6]],"zmax":21,"zmin":0,"type":"heatmap","xaxis":"x2","yaxis":"y2"},{"colorscale":[[0.0,"rgb(236, 218, 154)"],[0.16666666666666666,"rgb(239, 196, 126)"],[0.3333333333333333,"rgb(243, 173, 106)"],[0.5,"rgb(247, 148, 93)"],[0.6666666666666666,"rgb(249, 123, 87)"],[0.8333333333333334,"rgb(246, 99, 86)"],[1.0,"rgb(238, 77, 90)"]],"x":["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"y":["Day","Evening","Night"],"z":[[1,4,6,5,13,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]],"zmax":21,"zmin":0,"type":"heatmap","xaxis":"x3","yaxis":"y3"},{"colorbar":{"x":0.45},"colorscale":[[0.0,"rgb(236, 218, 154)"],[0.16666666666666666,"rgb(239, 196, 126)"],[0.3333333333333333,"rgb(243, 173, 106)"],[0.5,"rgb(247, 148, 93)"],[0.6666666666666666,"rgb(249, 123, 87)"],[0.8333333333333334,"rgb(246, 99, 86)"],[1.0,"rgb(238, 77, 90)"]],"x":["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"y":["Day","Evening","Night"],"z":[[1,8,12,3,13,2,2],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]],"zmax":21,"zmin":0,"type":"heatmap","xaxis":"x4","yaxis":"y4"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,0.425]},"yaxis":{"anchor":"x","domain":[0.625,1.0]},"xaxis2":{"anchor":"y2","domain":[0.575,1.0]},"yaxis2":{"anchor":"x2","domain":[0.625,1.0]},"xaxis3":{"anchor":"y3","domain":[0.0,0.425]},"yaxis3":{"anchor":"x3","domain":[0.0,0.375]},"xaxis4":{"anchor":"y4","domain":[0.575,1.0]},"yaxis4":{"anchor":"x4","domain":[0.0,0.375]},"annotations":[{"font":{"size":16},"showarrow":false,"text":"Week 0","x":0.2125,"xanchor":"center","xref":"paper","y":1.0,"yanchor":"bottom","yref":"paper"},{"font":{"size":16},"showarrow":false,"text":"Week 1","x":0.7875,"xanchor":"center","xref":"paper","y":1.0,"yanchor":"bottom","yref":"paper"},{"font":{"size":16},"showarrow":false,"text":"Week 2","x":0.2125,"xanchor":"center","xref":"paper","y":0.375,"yanchor":"bottom","yref":"paper"},{"font":{"size":16},"showarrow":false,"text":"Week 3","x":0.7875,"xanchor":"center","xref":"paper","y":0.375,"yanchor":"bottom","yref":"paper"}],"coloraxis":{"showscale":false},"title":{"text":"Nurse Surplus (Supply - Demand) | Solution File: data\u002f4WeekRosterSolution | Average Weekly Surplus: 38.5 | Average Daily Surplus: 5.5 | Average Daily Surplus Per 10 Nurses: 0.10"}},                        {"responsive": true}                    )                };                            </script>        </div>
</body>
</html>

## To implement this in real scenarios
First of all, there are some limitations to the model. We are taking advantage of only having 4 shifts types, which is not always the case. If the space of possible rosters become to large, this model won't work.

Secondly, the constraints and objective measures of the model can vary from department to department. These would to be tweaked and perhaps made more generic, so a config file with constraints and objective measures could be supplied for each department.

Furthermore, more development would have to be done to include features such as
* Input 2 weeks current schedule for all nurses as starting condition (this is already possible, just need a UI in Excel or similar for this)
* Specific requests for specific shifts on day (e.g. day off on the first Thursday) and not a specific shift on day (e.g. not a evening shift on second Friday).
* Holiday periods as part of plans.

One could perhaps also use this as a simulation tool to get inspiration of how the patterns and a combined schedule could look like.